<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>World's Hardest Game RL + Manual</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background-color: #1a1a1a;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .game-container {
            width: 800px;
            height: 600px;
            background-color: #8B8BFF;
            border: 3px solid black;
            position: relative;
        }
        .header {
            width: 100%;
            height: 50px;
            background-color: black;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            box-sizing: border-box;
            font-weight: bold;
            font-size: 16px;
        }
        .footer {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 50px;
            background-color: black;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            box-sizing: border-box;
            font-weight: bold;
            font-size: 16px;
        }
        .game-area {
            position: absolute;
            top: 50px;
            left: 0;
            width: 100%;
            height: 500px;
            background-color: #B8B8FF;
        }
        .start-zone {
            position: absolute;
            left: 30px;
            top: 150px;
            width: 132px;
            height: 206px;
            background-color: #90EE90;
            border: 3px solid black;
        }
        .end-zone {
            position: absolute;
            right: 30px;
            top: 150px;
            width: 120px;
            height: 200px;
            background-color: #90EE90;
            border: 3px solid black;
        }
        .corridor {
            position: absolute;
            left: 165px;
            top: 200px;
            width: 476px;
            height: 112px;
            background-color: white;
            border: 3px solid black;
        }
        .corridor-grid {
            width: 100%;
            height: 100%;
            background-image: 
                repeating-linear-gradient(0deg, transparent, transparent 12px, #E0E0E0 12px, #E0E0E0 13px),
                repeating-linear-gradient(90deg, transparent, transparent 12px, #E0E0E0 12px, #E0E0E0 13px);
        }
        .player {
            position: absolute;
            width: 15px;
            height: 15px;
            background-color: red;
            border-radius: 2px;
            z-index: 10;
        }
        .enemy {
            position: absolute;
            width: 12px;
            height: 12px;
            background-color: blue;
            border-radius: 50%;
            z-index: 5;
        }
        .instructions {
            position: absolute;
            top: 60px;
            left: 20px;
            color: black;
            font-size: 12px;
            width: 120px;
        }
        .game-over, .win-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            display: none;
            z-index: 100;
        }
        .win-message {
            background-color: rgba(0, 128, 0, 0.9);
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="game-container">
        <div class="header">
            <span>MENU</span>
            <span id="level">1/30</span>
            <span id="deaths">DEATHS: 0</span>
        </div>
        <div class="game-area">
            <div class="start-zone"></div>
            <div class="end-zone"></div>
            <div class="corridor">
                <div class="corridor-grid"></div>
            </div>
            <div class="player" id="player"></div>
            <div class="enemy" id="enemy1"></div>
            <div class="enemy" id="enemy2"></div>
            <div class="enemy" id="enemy3"></div>
            <div class="enemy" id="enemy4"></div>
            <div class="enemy" id="enemy5"></div>
            <div class="enemy" id="enemy6"></div>
            <div class="enemy" id="enemy7"></div>
            <div class="enemy" id="enemy8"></div>
            <div class="enemy" id="enemy9"></div>
            <div class="enemy" id="enemy10"></div>
            <div class="instructions" id="instText">
                Use Arrow keys or WASD to play<br>
                RL-Agent bağlanınca AI oynamaya başlar
            </div>
        </div>
        <div class="footer">
            <span>PLAY MORE GAMES</span>
            <span>SNUBBY LAND</span>
        </div>
        <div class="game-over" id="gameOver">
            <h2>Game Over!</h2>
            <button onclick="onRestart()">Try Again</button>
        </div>
        <div class="win-message" id="winMessage">
            <h2>Level Complete!</h2>
            <button onclick="nextLevel()">Next Level</button>
        </div>
        
    </div>
    <script>
        // ----------- Oyun değişkenleri ve ayarları -----------
        const player = document.getElementById('player');
        const enemies = [
            document.getElementById('enemy1'),document.getElementById('enemy2'),document.getElementById('enemy3'),
            document.getElementById('enemy4'),document.getElementById('enemy5'),document.getElementById('enemy6'),
            document.getElementById('enemy7'),document.getElementById('enemy8'),document.getElementById('enemy9'),document.getElementById('enemy10')
        ];
        const gameOverDiv = document.getElementById('gameOver');
        const winMessageDiv = document.getElementById('winMessage');
        const deathsElement = document.getElementById('deaths');
        const instText = document.getElementById('instText');

        let playerX = 90, playerY = 240;
        let lastPlayerX = playerX, lastPlayerY = playerY;
        let playerVX = 0, playerVY = 0;
        let deaths = 0, gameRunning = true, AIcontrol = false;

        const corridorLeft = 165, corridorTop = 200, corridorWidth = 476, corridorHeight = 112;
        const enemyCount = 10, space = Math.floor((corridorWidth - 20) / (enemyCount - 1));
        const enemyData = Array.from({ length: enemyCount }).map((_, i) => ({
            x: corridorLeft + 10 + i * space,
            y: corridorTop + 10,
            dy: (i % 2 === 0 ? 1 : -1),
            speed: 1 + (i % 3) * 0.4
        }));

        function onRestart() {
            // RL-Agent açıksa AI ile devam, manueldeyse insan kontrolü!
            if (AIcontrol) {
                resetGame(); // AI açık kalacak, klavye yine devre dışı
                if (ws && ws.readyState === 1) {
                    // RL agent'a tekrar state gönder
                    sendStateRewardDone(0, false);
                }
            } else {
                resetGame();
                // Tüm tuşları bırak
                Object.keys(keys).forEach(k => keys[k] = false);
                // Manuel kontrolü aktifleştir
                AIcontrol = false;
                instText.innerHTML = "Klavye ile oyna<br>RL-Agent kapalı.";
            }
        }
        function nextLevel() {
            resetGame();
            // Eğer AI modundaysa, ilk state'i tekrar gönder:
            if (AIcontrol && ws && ws.readyState === 1) {
                sendStateRewardDone(0, false); // <--- Epizodu tetikler!
            }
        }


        function updatePlayer() {
            player.style.left = playerX + 'px';
            player.style.top = playerY + 'px';
        }
        function updateEnemies() {
            for (let i = 0; i < enemies.length; i++) {
                const data = enemyData[i];
                data.y += data.dy * data.speed;
                if (data.y <= corridorTop + 5 || data.y >= corridorTop + corridorHeight - 17) {
                    data.dy *= -1;
                }
                enemies[i].style.left = data.x + 'px';
                enemies[i].style.top = data.y + 'px';
            }
        }
        function checkCollisions() {
            const playerRect = {x: playerX, y: playerY, width: 15, height: 15};
            for (let i = 0; i < enemies.length; i++) {
                const data = enemyData[i];
                const enemyRect = {x: data.x, y: data.y, width: 12, height: 12};
                if (
                    playerRect.x < enemyRect.x + enemyRect.width &&
                    playerRect.x + playerRect.width > enemyRect.x &&
                    playerRect.y < enemyRect.y + enemyRect.height &&
                    playerRect.y + playerRect.height > enemyRect.y
                ) {
                    gameRunning = false;
                    deaths++;
                    deathsElement.textContent = 'DEATHS: ' + deaths;
                    // Burada otomatik reset yok!
                    setTimeout(() => {
                        resetGame();
                    }, 500); // Burası sadece kaybedince otomatik reset için, kazanırken reset yok!
                    return true;
                }
            }
            if (playerX > 635 && playerY > 150 && playerY < 350) {
                gameRunning = false;
                winMessageDiv.style.display = 'block';
                setTimeout(() => {
                    alert("Kazandınız!");
                }, 100); // 100 ms sonra popup çıkıyor, isteğe göre süreyi arttırabilirsin
                return true;
            }
            return false;
        }

        function resetGame() {
            playerX = 90; playerY = 240;
            lastPlayerX = playerX; lastPlayerY = playerY;
            playerVX = 0; playerVY = 0;
            gameRunning = true;
            gameOverDiv.style.display = 'none';
            winMessageDiv.style.display = 'none';
            for (let i = 0; i < enemyCount; i++) {
                enemyData[i].y = corridorTop + 10;
                enemyData[i].dy = (i % 2 === 0 ? 1 : -1);
            }
            updatePlayer();
            // Tuşları bırak
            Object.keys(keys).forEach(k => keys[k] = false);
        }

        function nextLevel() {
            resetGame();
            if (AIcontrol && ws && ws.readyState === 1) {
                sendStateRewardDone(0, false);
            }
        }


        // --------- Klavye ile oyun (manuel) ---------
        const keys = { ArrowUp: false, ArrowDown: false, ArrowLeft: false, ArrowRight: false, w: false, a: false, s: false, d: false };
        const moveSpeed = 2.1;

        document.addEventListener('keydown', function(e) {
            if (!gameRunning || AIcontrol) return;
            if (e.key in keys) keys[e.key] = true;
        });
        document.addEventListener('keyup', function(e) {
            if (!gameRunning || AIcontrol) return;
            if (e.key in keys) keys[e.key] = false;
        });

        // --------- Ana oyun frame döngüsü ---------
        function gameLoop() {
            updateEnemies();

            if (gameRunning) {
                // Manuel kontrol (AI yoksa)
                if (!AIcontrol) {
                    let dx = 0, dy = 0;
                    if (keys.ArrowUp || keys.w) dy -= 1;
                    if (keys.ArrowDown || keys.s) dy += 1;
                    if (keys.ArrowLeft || keys.a) dx -= 1;
                    if (keys.ArrowRight || keys.d) dx += 1;
                    if (dx !== 0 || dy !== 0) {
                        const len = Math.sqrt(dx*dx + dy*dy);
                        dx = dx / len;
                        dy = dy / len;
                        let newX = playerX + dx * moveSpeed;
                        let newY = playerY + dy * moveSpeed;
                        if (newX >= 30 && newX <= 770 && newY >= 50 && newY <= 535) {
                            const inStartZone = (newX >= 30 && newX <= 155 && newY >= 150 && newY <= 350);
                            const inCorridor = (newX >= 150 && newX <= 635 && newY >= 200 && newY <= 300);
                            const inEndZone = (newX >= 630 && newX <= 770 && newY >= 150 && newY <= 350);
                            const inStartToCorridor = (newX >= 150 && newX <= 155 && newY >= 200 && newY <= 300);
                            const inCorridorToEnd = (newX >= 495 && newX <= 500 && newY >= 200 && newY <= 300);
                            if (inStartZone || inCorridor || inEndZone || inStartToCorridor || inCorridorToEnd) {
                                playerVX = newX - lastPlayerX;
                                playerVY = newY - lastPlayerY;
                                lastPlayerX = playerX;
                                lastPlayerY = playerY;
                                playerX = newX;
                                playerY = newY;
                                updatePlayer();
                            }
                        }
                    } else {
                        playerVX = 0; playerVY = 0;
                    }
                    updatePlayer();
                }
            }
            checkCollisions();
            requestAnimationFrame(gameLoop);
        }
        gameLoop();

        // --------- RL-AGENT WebSocket Desteği ----------
        let ws;
        function connectWebSocket() {
            ws = new WebSocket("ws://localhost:8765/");
            ws.onopen = () => {
                // RL agent aktif olsun, ilk state'i gönder!
                AIcontrol = true;
                instText.innerHTML = "AI (RL-Agent) aktif!<br>İnsan kontrolü devre dışı.";
                sendStateRewardDone(0, false); // <--- ilk state'i yolla
            };
            ws.onclose = () => {
                AIcontrol = false;
                instText.innerHTML = "Klavye ile oyna<br>RL-Agent bağlantısı kesildi";
                setTimeout(connectWebSocket, 2000);
            };
            ws.onerror = err => console.error("WebSocket error:", err);

            let prevDist = null;

            function getDistanceToGoal(px, py) {
                // End zone'un merkezini bulalım
                const endZoneCenterX = 635 + 60; // end zone x + yarı genişlik
                const endZoneCenterY = 150 + 100; // end zone y + yarı yükseklik
                return Math.abs(px - endZoneCenterX) + Math.abs(py - endZoneCenterY); // Manhattan mesafe
            }

            // WebSocket onmessage içinde, AI action gelince:
            ws.onmessage = function(event) {
                AIcontrol = true;
                instText.innerHTML = "AI (RL-Agent) aktif!<br>İnsan kontrolü devre dışı.";
                const action = JSON.parse(event.data);
                let collisionOrGoal = false;

                // ------ 1. Reward shaping için distance hesapla ------
                if (prevDist === null) prevDist = getDistanceToGoal(playerX, playerY);

                if (gameRunning) {
                    applyAction(action);
                    updatePlayer();
                    collisionOrGoal = checkCollisions();
                }

                // --- 2. Yeni reward hesapla ---
                let reward = -1; // default step penalty
                let done = false;
                let newDist = getDistanceToGoal(playerX, playerY);

                let delta = prevDist - newDist;
                if (delta > 0) reward += 0.2; // hedefe yaklaştıysa
                else reward -= 0.2; // uzaklaştıysa

                if (collisionOrGoal) {
                    if (winMessageDiv.style.display === 'block') reward = 100;
                    else reward = -100;
                    done = true;
                    prevDist = null; // Epizod bitti, resetle
                } else {
                    prevDist = newDist; // Son mesafeyi güncelle
                }

                sendStateRewardDone(reward, done);
            };
        }
        connectWebSocket();


        function applyAction(action) {
            let dx = 0, dy = 0;
            switch(action) {
                case 1: dy = -1; break; // up
                case 2: dy = 1; break;  // down
                case 3: dx = -1; break; // left
                case 4: dx = 1; break;  // right
                case 5: dx = -1; dy = -1; break;
                case 6: dx = 1; dy = -1; break;
                case 7: dx = -1; dy = 1; break;
                case 8: dx = 1; dy = 1; break;
                default: break;
            }
            if (dx !== 0 && dy !== 0) {
                dx = dx / Math.sqrt(2);
                dy = dy / Math.sqrt(2);
            }
            let newX = playerX + dx * moveSpeed;
            let newY = playerY + dy * moveSpeed;
            if (newX >= 30 && newX <= 770 && newY >= 50 && newY <= 535) {
                const inStartZone = (newX >= 30 && newX <= 155 && newY >= 150 && newY <= 350);
                const inCorridor = (newX >= 150 && newX <= 635 && newY >= 200 && newY <= 300);
                const inEndZone = (newX >= 630 && newX <= 770 && newY >= 150 && newY <= 350);
                const inStartToCorridor = (newX >= 150 && newX <= 155 && newY >= 200 && newY <= 300);

                const inCorridorToEnd = (newX >= 495 && newX <= 500 && newY >= 200 && newY <= 300);
                if (inStartZone || inCorridor || inEndZone || inStartToCorridor || inCorridorToEnd) {
                    playerVX = newX - lastPlayerX;
                    playerVY = newY - lastPlayerY;
                    lastPlayerX = playerX;
                    lastPlayerY = playerY;
                    playerX = newX;
                    playerY = newY;
                }
            }
        }
        function getState() {
            const playerState = [playerX, playerY, playerVX || 0, playerVY || 0];
            const enemiesState = [];
            for (let i = 0; i < enemyCount; i++) {
                enemiesState.push(
                    enemyData[i].x, enemyData[i].y, enemyData[i].dy, enemyData[i].speed
                );
            }
            const endZone = [650, 150, 120, 200];
            return [...playerState, ...enemiesState, ...endZone];
        }
        function sendStateRewardDone(reward, done) {
            if (ws && ws.readyState === 1) {
                ws.send(JSON.stringify({
                    state: getState(),
                    reward: reward,
                    done: done
                }));
            }
        }
    </script>
</body>
</html>
